<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SpaCOAP: simulation â€¢ SpaCOAP</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="SpaCOAP: simulation">
<meta property="og:description" content="SpaCOAP">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SpaCOAP</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/mouseSpleen.html">SpaCOAP: mouse spleen dataset</a>
    </li>
    <li>
      <a href="../articles/simu.html">SpaCOAP: simulation</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/feiyoung/SpaCOAP/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>SpaCOAP: simulation</h1>
                        <h4 data-toc-skip class="author">Wei Liu</h4>
            
            <h4 data-toc-skip class="date">2024-05-25</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/feiyoung/SpaCOAP/blob/HEAD/vignettes/simu.Rmd" class="external-link"><code>vignettes/simu.Rmd</code></a></small>
      <div class="hidden name"><code>simu.Rmd</code></div>

    </div>

    
    
<p>This vignette introduces the usage of SpaCOAP for the analysis of high-dimensional count data with additional high-dimensional covariates, by comparison with other methods.</p>
<p>The package can be loaded with the command:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/feiyoung/SpaCOAP" class="external-link">SpaCOAP</a></span><span class="op">)</span>
<span class="co">#&gt; SpaCOAP :  A spatial covariate-augmented overdispersed Poisson factor model is proposed to perform efficient latent representation learning method for high-dimensional large-scale spatial count data with additional covariates.   Check out our Package website (https://feiyoung.github.io/SpaCOAP/docs/index.html) for a more complete description of the methods and analyses</span></code></pre></div>
<div class="section level2">
<h2 id="generate-the-simulated-data">Generate the simulated data<a class="anchor" aria-label="anchor" href="#generate-the-simulated-data"></a>
</h2>
<p>First, we generate the data simulated data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">width</span> <span class="op">&lt;-</span> <span class="fl">20</span>; <span class="va">height</span> <span class="op">&lt;-</span> <span class="fl">30</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="va">width</span><span class="op">*</span><span class="va">height</span>
<span class="va">p</span><span class="op">=</span><span class="fl">500</span>
<span class="va">q</span> <span class="op">=</span> <span class="fl">5</span>; <span class="va">d</span> <span class="op">&lt;-</span> <span class="fl">40</span>; <span class="va">k</span> <span class="op">&lt;-</span> <span class="fl">3</span>; <span class="va">r</span> <span class="op">&lt;-</span> <span class="fl">3</span>
<span class="va">bandwidth</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="va">rho</span><span class="op">&lt;-</span>   <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8</span>,<span class="fl">0.6</span><span class="op">)</span> 
<span class="va">sigma2_eps</span><span class="op">=</span><span class="fl">1</span>
<span class="va">datlist</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gendata_spacoap.html">gendata_spacoap</a></span><span class="op">(</span>seed<span class="op">=</span><span class="fl">1</span>, width<span class="op">=</span><span class="va">width</span>, height <span class="op">=</span> <span class="va">height</span>,
                           p<span class="op">=</span><span class="va">p</span>, q<span class="op">=</span><span class="va">q</span>, d<span class="op">=</span><span class="va">d</span>, k<span class="op">=</span><span class="va">k</span>, rank0 <span class="op">=</span> <span class="va">r</span>, bandwidth<span class="op">=</span><span class="fl">1</span>,
                           eta0 <span class="op">=</span> <span class="fl">0.5</span>, rho<span class="op">=</span><span class="va">rho</span>, sigma2_eps<span class="op">=</span><span class="va">sigma2_eps</span><span class="op">)</span>
<span class="co">#&gt; Loading required package: MASS</span>
<span class="co">#&gt; Loading required package: Matrix</span>
<span class="va">X_count</span> <span class="op">&lt;-</span> <span class="va">datlist</span><span class="op">$</span><span class="va">X</span>; <span class="va">H</span> <span class="op">&lt;-</span> <span class="va">datlist</span><span class="op">$</span><span class="va">H</span>; <span class="va">Z</span> <span class="op">&lt;-</span> <span class="va">datlist</span><span class="op">$</span><span class="va">Z</span>
<span class="va">F0</span> <span class="op">&lt;-</span> <span class="va">datlist</span><span class="op">$</span><span class="va">F0</span>; <span class="va">B0</span> <span class="op">&lt;-</span> <span class="va">datlist</span><span class="op">$</span><span class="va">B0</span>
<span class="va">bbeta0</span> <span class="op">&lt;-</span> <span class="va">datlist</span><span class="op">$</span><span class="va">bbeta0</span>; <span class="va">alpha0</span> <span class="op">&lt;-</span> <span class="va">datlist</span><span class="op">$</span><span class="va">alpha0</span>
<span class="va">Adj_sp</span> <span class="op">&lt;-</span> <span class="fu">SpaCOAP</span><span class="fu">:::</span><span class="fu">getneighbor_weightmat</span><span class="op">(</span><span class="va">datlist</span><span class="op">$</span><span class="va">pos</span>, <span class="fl">1.1</span>,  <span class="va">bandwidth</span><span class="op">)</span></code></pre></div>
<p>Fit the SpaCOAP model using the function <code><a href="../reference/SpaCOAP.html">SpaCOAP()</a></code> in the R package <code>SpaCOAP</code>. Users can use <code><a href="../reference/SpaCOAP.html">?SpaCOAP</a></code> to see the details about this function.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">reslist</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SpaCOAP.html">SpaCOAP</a></span><span class="op">(</span><span class="va">X_count</span>,<span class="va">Adj_sp</span>, <span class="va">H</span>, Z <span class="op">=</span> <span class="va">Z</span>, rank_use <span class="op">=</span> <span class="va">r</span>, q<span class="op">=</span><span class="va">q</span><span class="op">)</span>
<span class="co">#&gt; Calculate initial values...</span>
<span class="co">#&gt; Loading required package: irlba</span>
<span class="co">#&gt; Model fitting...</span>
<span class="co">#&gt; iter = 2, ELBO= 56912099.620381, dELBO=1.026502 </span>
<span class="co">#&gt; iter = 3, ELBO= 56950601.467993, dELBO=0.000677 </span>
<span class="co">#&gt; iter = 4, ELBO= 56967115.145794, dELBO=0.000290 </span>
<span class="co">#&gt; iter = 5, ELBO= 56976132.467438, dELBO=0.000158 </span>
<span class="co">#&gt; iter = 6, ELBO= 56981589.442438, dELBO=0.000096 </span>
<span class="co">#&gt; iter = 7, ELBO= 56985170.224074, dELBO=0.000063 </span>
<span class="co">#&gt; iter = 8, ELBO= 56987659.518739, dELBO=0.000044 </span>
<span class="co">#&gt; iter = 9, ELBO= 56989466.471227, dELBO=0.000032 </span>
<span class="co">#&gt; iter = 10, ELBO= 56990823.004329, dELBO=0.000024 </span>
<span class="co">#&gt; iter = 11, ELBO= 56991869.249408, dELBO=0.000018 </span>
<span class="co">#&gt; iter = 12, ELBO= 56992694.260056, dELBO=0.000014 </span>
<span class="co">#&gt; iter = 13, ELBO= 56993357.005478, dELBO=0.000012 </span>
<span class="co">#&gt; iter = 14, ELBO= 56993897.892980, dELBO=0.000009 </span>
<span class="co">#&gt; iter = 15, ELBO= 56994345.422359, dELBO=0.000008 </span>
<span class="co">#&gt; iter = 16, ELBO= 56994720.196299, dELBO=0.000007 </span>
<span class="co">#&gt; iter = 17, ELBO= 56995037.427338, dELBO=0.000006 </span>
<span class="co">#&gt; iter = 18, ELBO= 56995308.555786, dELBO=0.000005 </span>
<span class="co">#&gt; iter = 19, ELBO= 56995542.323628, dELBO=0.000004 </span>
<span class="co">#&gt; iter = 20, ELBO= 56995745.505269, dELBO=0.000004 </span>
<span class="co">#&gt; iter = 21, ELBO= 56995923.415920, dELBO=0.000003 </span>
<span class="co">#&gt; iter = 22, ELBO= 56996080.272269, dELBO=0.000003 </span>
<span class="co">#&gt; iter = 23, ELBO= 56996219.452929, dELBO=0.000002 </span>
<span class="co">#&gt; iter = 24, ELBO= 56996343.689452, dELBO=0.000002 </span>
<span class="co">#&gt; iter = 25, ELBO= 56996455.208402, dELBO=0.000002 </span>
<span class="co">#&gt; iter = 26, ELBO= 56996555.838389, dELBO=0.000002 </span>
<span class="co">#&gt; iter = 27, ELBO= 56996647.091606, dELBO=0.000002 </span>
<span class="co">#&gt; iter = 28, ELBO= 56996730.226610, dELBO=0.000001 </span>
<span class="co">#&gt; iter = 29, ELBO= 56996806.297101, dELBO=0.000001 </span>
<span class="co">#&gt; iter = 30, ELBO= 56996876.190180, dELBO=0.000001</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">reslist</span><span class="op">)</span>
<span class="co">#&gt; List of 10</span>
<span class="co">#&gt;  $ F        : num [1:600, 1:5] -0.706 0.796 -1.143 1.179 0.768 ...</span>
<span class="co">#&gt;  $ B        : num [1:500, 1:5] 0.0646 0.4818 -0.0207 -0.2665 0.045 ...</span>
<span class="co">#&gt;  $ bbeta    : num [1:500, 1:40] 0.746 0.961 2.003 0.823 1.202 ...</span>
<span class="co">#&gt;  $ alpha    : num [1:500, 1:3] -0.105 0.4866 0.0135 1.5708 0.9333 ...</span>
<span class="co">#&gt;  $ invLambda: num [1:500, 1] 1.1 1.24 1.05 1.19 1.08 ...</span>
<span class="co">#&gt;  $ eta      : num 0.578</span>
<span class="co">#&gt;  $ S        : num [1:5, 1:5, 1:600] 6.43e-03 4.46e-05 -8.16e-05 1.84e-05 6.21e-05 ...</span>
<span class="co">#&gt;  $ ELBO     : num 5.7e+07</span>
<span class="co">#&gt;  $ ELBO_seq : num [1:30] -2.15e+09 5.69e+07 5.70e+07 5.70e+07 5.70e+07 ...</span>
<span class="co">#&gt;  $ time_use : Named num 4.85</span>
<span class="co">#&gt;   ..- attr(*, "names")= chr "elapsed"</span></code></pre></div>
<p>Check the increased property of the envidence lower bound function.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>
<span class="co">#&gt; Warning: package 'ggplot2' was built under R version 4.1.3</span>
<span class="va">dat_iter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>iter<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">reslist</span><span class="op">$</span><span class="va">ELBO_seq</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, ELBO<span class="op">=</span><span class="va">reslist</span><span class="op">$</span><span class="va">ELBO_seq</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">dat_iter</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">iter</span>, y<span class="op">=</span><span class="va">ELBO</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></code></pre></div>
<p><img src="simu_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>We calculate the metrics to measure the estimatioin accuracy, where the trace statistic is used to measure the estimation accuracy of loading matrix and prediction accuracy of factor matrix, and the mean absolute error is adopted to measure the estimation error of bbeta and alpha.</p>
<p>First, we define the metric functions:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">norm1_vec</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="va">trace_statistic_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">H</span>, <span class="va">H0</span><span class="op">)</span><span class="op">{</span>
  
  <span class="va">tr_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
  <span class="va">mat1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">H0</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">H</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/qr.html" class="external-link">qr.solve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">H</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">H</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">H</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">H0</span>
  
  <span class="fu">tr_fun</span><span class="op">(</span><span class="va">mat1</span><span class="op">)</span> <span class="op">/</span> <span class="fu">tr_fun</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">H0</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">H0</span><span class="op">)</span>
  
<span class="op">}</span></code></pre></div>
<p>Then, we calculate the quantities for SpaCOAP.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">metricList</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">metricList</span><span class="op">$</span><span class="va">SpaCOAP</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">metricList</span><span class="op">$</span><span class="va">SpaCOAP</span><span class="op">$</span><span class="va">F_tr</span> <span class="op">&lt;-</span> <span class="fu">trace_statistic_fun</span><span class="op">(</span><span class="va">reslist</span><span class="op">$</span><span class="cn">F</span>, <span class="va">F0</span><span class="op">)</span>
<span class="va">metricList</span><span class="op">$</span><span class="va">SpaCOAP</span><span class="op">$</span><span class="va">B_tr</span> <span class="op">&lt;-</span> <span class="fu">trace_statistic_fun</span><span class="op">(</span><span class="va">reslist</span><span class="op">$</span><span class="va">B</span>, <span class="va">B0</span><span class="op">)</span>
<span class="va">metricList</span><span class="op">$</span><span class="va">SpaCOAP</span><span class="op">$</span><span class="va">alpha_norm1</span> <span class="op">&lt;-</span> <span class="fu">norm1_vec</span><span class="op">(</span><span class="va">reslist</span><span class="op">$</span><span class="va">alpha</span><span class="op">-</span> <span class="va">alpha0</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">alpha0</span><span class="op">)</span><span class="op">)</span>  
<span class="va">metricList</span><span class="op">$</span><span class="va">SpaCOAP</span><span class="op">$</span><span class="va">beta_norm1</span><span class="op">&lt;-</span> <span class="fu">norm1_vec</span><span class="op">(</span><span class="va">reslist</span><span class="op">$</span><span class="va">bbeta</span><span class="op">-</span> <span class="va">bbeta0</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">bbeta0</span><span class="op">)</span><span class="op">)</span>
<span class="va">metricList</span><span class="op">$</span><span class="va">SpaCOAP</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;-</span> <span class="va">reslist</span><span class="op">$</span><span class="va">time_use</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="compare-with-other-methods">Compare with other methods<a class="anchor" aria-label="anchor" href="#compare-with-other-methods"></a>
</h2>
<p>We compare SpaCOAP with various prominent methods in the literature. (1) COAP performs covariate-argumented Poisson factor model with the consideration of the low-rank structure of the coefficient matrix, but falls short in accounting for the spatial dependence among units, which is implemented in the R package <strong>COAP</strong>; (2) PLNPCA performs covariate-argumented PCA without considering the low-rank structure of the coefficient matrix and spatial dependence among units, which is implemented in the R package <strong>PLNmodels</strong>; (3) Multi-response reduced-rank Poisson regression model (MRRR) performs the estimation of low-rank coefficient matrix and factor part by treating them as a single entity, and fails to account for spatial dependence among units, which is implemented in <strong>rrpack</strong> R package. (4) Spatial Poisson factor model, called FAST, takes into account spatial dependence among units, but unable to account for additional covariates, which is implemented in the R package <strong>ProFAST</strong>.</p>
<p>First, we implement COAP method:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/feiyoung/COAP" class="external-link">COAP</a></span><span class="op">)</span>
<span class="co">#&gt; COAP :  A covariate-augmented overdispersed Poisson factor model is proposed to jointly perform a high-dimensional Poisson factor analysis and estimate a large coefficient matrix for overdispersed count data.</span>
<span class="co">#&gt; More details can be referred to Liu et al. (2024) &lt;doi:10.1093/biomtc/ujae031&gt;.</span>
<span class="va">tic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html" class="external-link">proc.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">res_coap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/COAP/man/RR_COAP.html" class="external-link">RR_COAP</a></span><span class="op">(</span><span class="va">X_count</span>, Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Z</span>, <span class="va">H</span><span class="op">)</span>, rank_use<span class="op">=</span> <span class="va">k</span><span class="op">+</span><span class="va">r</span>, q<span class="op">=</span><span class="fl">5</span>, epsELBO <span class="op">=</span> <span class="fl">1e-9</span><span class="op">)</span>
<span class="co">#&gt; Calculate initial values...</span>
<span class="co">#&gt; iter = 2, ELBO= 56909331.756814, dELBO=1.026500 </span>
<span class="co">#&gt; iter = 3, ELBO= 56945921.403791, dELBO=0.000643 </span>
<span class="co">#&gt; iter = 4, ELBO= 56963201.970295, dELBO=0.000303 </span>
<span class="co">#&gt; iter = 5, ELBO= 56973402.388227, dELBO=0.000179 </span>
<span class="co">#&gt; iter = 6, ELBO= 56980291.185281, dELBO=0.000121 </span>
<span class="co">#&gt; iter = 7, ELBO= 56985222.615852, dELBO=0.000087 </span>
<span class="co">#&gt; iter = 8, ELBO= 56988810.790700, dELBO=0.000063 </span>
<span class="co">#&gt; iter = 9, ELBO= 56991427.899858, dELBO=0.000046 </span>
<span class="co">#&gt; iter = 10, ELBO= 56993342.408213, dELBO=0.000034 </span>
<span class="co">#&gt; iter = 11, ELBO= 56994754.250565, dELBO=0.000025 </span>
<span class="co">#&gt; iter = 12, ELBO= 56995809.008341, dELBO=0.000019 </span>
<span class="co">#&gt; iter = 13, ELBO= 56996609.997192, dELBO=0.000014 </span>
<span class="co">#&gt; iter = 14, ELBO= 56997229.499532, dELBO=0.000011 </span>
<span class="co">#&gt; iter = 15, ELBO= 56997717.994913, dELBO=0.000009 </span>
<span class="co">#&gt; iter = 16, ELBO= 56998111.035454, dELBO=0.000007 </span>
<span class="co">#&gt; iter = 17, ELBO= 56998434.081278, dELBO=0.000006 </span>
<span class="co">#&gt; iter = 18, ELBO= 56998705.809820, dELBO=0.000005 </span>
<span class="co">#&gt; iter = 19, ELBO= 56998940.367212, dELBO=0.000004 </span>
<span class="co">#&gt; iter = 20, ELBO= 56999148.915226, dELBO=0.000004 </span>
<span class="co">#&gt; iter = 21, ELBO= 56999340.718450, dELBO=0.000003 </span>
<span class="co">#&gt; iter = 22, ELBO= 56999523.932512, dELBO=0.000003 </span>
<span class="co">#&gt; iter = 23, ELBO= 56999706.193167, dELBO=0.000003 </span>
<span class="co">#&gt; iter = 24, ELBO= 56999895.060794, dELBO=0.000003 </span>
<span class="co">#&gt; iter = 25, ELBO= 57000098.338034, dELBO=0.000004 </span>
<span class="co">#&gt; iter = 26, ELBO= 57000324.245536, dELBO=0.000004 </span>
<span class="co">#&gt; iter = 27, ELBO= 57000581.411069, dELBO=0.000005 </span>
<span class="co">#&gt; iter = 28, ELBO= 57000878.604670, dELBO=0.000005 </span>
<span class="co">#&gt; iter = 29, ELBO= 57001224.148357, dELBO=0.000006 </span>
<span class="co">#&gt; iter = 30, ELBO= 57001624.961718, dELBO=0.000007</span>
<span class="va">toc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html" class="external-link">proc.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">time_coap</span> <span class="op">&lt;-</span> <span class="va">toc</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">tic</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
<span class="va">metricList</span><span class="op">$</span><span class="va">COAP</span><span class="op">$</span><span class="va">F_tr</span> <span class="op">&lt;-</span> <span class="fu">trace_statistic_fun</span><span class="op">(</span><span class="va">res_coap</span><span class="op">$</span><span class="va">H</span>, <span class="va">F0</span><span class="op">)</span>
<span class="va">metricList</span><span class="op">$</span><span class="va">COAP</span><span class="op">$</span><span class="va">B_tr</span> <span class="op">&lt;-</span> <span class="fu">trace_statistic_fun</span><span class="op">(</span><span class="va">res_coap</span><span class="op">$</span><span class="va">B</span>, <span class="va">B0</span><span class="op">)</span>
<span class="va">alpha_coap</span> <span class="op">&lt;-</span> <span class="va">res_coap</span><span class="op">$</span><span class="va">bbeta</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="va">k</span><span class="op">]</span>
<span class="va">beta_coap</span> <span class="op">&lt;-</span> <span class="va">res_coap</span><span class="op">$</span><span class="va">bbeta</span><span class="op">[</span>,<span class="op">(</span><span class="va">k</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">k</span><span class="op">+</span><span class="va">d</span><span class="op">)</span><span class="op">]</span>
<span class="va">metricList</span><span class="op">$</span><span class="va">COAP</span><span class="op">$</span><span class="va">alpha_norm1</span> <span class="op">&lt;-</span> <span class="fu">norm1_vec</span><span class="op">(</span><span class="va">alpha_coap</span><span class="op">-</span> <span class="va">alpha0</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">alpha0</span><span class="op">)</span><span class="op">)</span>
<span class="va">metricList</span><span class="op">$</span><span class="va">COAP</span><span class="op">$</span><span class="va">beta_norm1</span> <span class="op">&lt;-</span> <span class="fu">norm1_vec</span><span class="op">(</span><span class="va">beta_coap</span><span class="op">-</span> <span class="va">bbeta0</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">bbeta0</span><span class="op">)</span><span class="op">)</span>
<span class="va">metricList</span><span class="op">$</span><span class="va">COAP</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;-</span> <span class="va">time_coap</span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Secondly, we implemented the PLNPCA and record the metrics that measure the estimation accuracy and computational cost.</li>
</ol>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">PLNPCA_run</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X_count</span>, <span class="va">covariates</span>, <span class="va">q</span>,  <span class="va">Offset</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X_count</span><span class="op">)</span><span class="op">)</span>, <span class="va">workers</span><span class="op">=</span><span class="cn">NULL</span>,
                       <span class="va">maxIter</span><span class="op">=</span><span class="fl">10000</span>,<span class="va">ftol_rel</span><span class="op">=</span><span class="fl">1e-8</span>, <span class="va">xtol_rel</span><span class="op">=</span> <span class="fl">1e-4</span><span class="op">)</span><span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://pln-team.github.io/PLNmodels/" class="external-link">PLNmodels</a></span><span class="op">)</span>
  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">workers</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="st">"multisession"</span>, workers <span class="op">=</span> <span class="va">workers</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">is.character</a></span><span class="op">(</span><span class="va">Offset</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="va">dat_plnpca</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://pln-team.github.io/PLNmodels/reference/prepare_data.html" class="external-link">prepare_data</a></span><span class="op">(</span><span class="va">X_count</span>, <span class="va">covariates</span><span class="op">)</span>
    <span class="va">dat_plnpca</span><span class="op">$</span><span class="va">Offset</span> <span class="op">&lt;-</span> <span class="va">Offset</span>
  <span class="op">}</span><span class="kw">else</span><span class="op">{</span>
    <span class="va">dat_plnpca</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://pln-team.github.io/PLNmodels/reference/prepare_data.html" class="external-link">prepare_data</a></span><span class="op">(</span><span class="va">X_count</span>, <span class="va">covariates</span>, offset <span class="op">=</span> <span class="va">Offset</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">covariates</span><span class="op">)</span>
  <span class="co">#  offset(log(Offset))+</span>
  <span class="va">formu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Abundance ~ 1 + offset(log(Offset))+"</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"V"</span>,<span class="fl">1</span><span class="op">:</span><span class="va">d</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">'+'</span><span class="op">)</span><span class="op">)</span>
  <span class="va">control_use</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>maxeval<span class="op">=</span><span class="va">maxIter</span>, ftol_rel<span class="op">=</span><span class="va">ftol_rel</span>, xtol_rel<span class="op">=</span> <span class="va">ftol_rel</span><span class="op">)</span>
  <span class="va">control_main</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://pln-team.github.io/PLNmodels/reference/PLNPCA_param.html" class="external-link">PLNPCA_param</a></span><span class="op">(</span>
    backend <span class="op">=</span> <span class="st">"nlopt"</span>,
    trace <span class="op">=</span> <span class="fl">1</span>,
    config_optim <span class="op">=</span> <span class="va">control_use</span>,
    inception <span class="op">=</span> <span class="cn">NULL</span>
  <span class="op">)</span>
  
  <span class="va">myPCA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://pln-team.github.io/PLNmodels/reference/PLNPCA.html" class="external-link">PLNPCA</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="va">formu</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dat_plnpca</span>, ranks <span class="op">=</span> <span class="va">q</span>,  control <span class="op">=</span> <span class="va">control_main</span><span class="op">)</span>
  
  <span class="va">myPCA1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://pln-team.github.io/PLNmodels/reference/getBestModel.html" class="external-link">getBestModel</a></span><span class="op">(</span><span class="va">myPCA</span><span class="op">)</span>
  <span class="va">myPCA1</span><span class="op">$</span><span class="va">scores</span>
  
  <span class="va">res_plnpca</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>PCs<span class="op">=</span> <span class="va">myPCA1</span><span class="op">$</span><span class="va">scores</span>, bbeta<span class="op">=</span> <span class="va">myPCA1</span><span class="op">$</span><span class="va">model_par</span><span class="op">$</span><span class="va">B</span>, 
                     loadings<span class="op">=</span><span class="va">myPCA1</span><span class="op">$</span><span class="va">model_par</span><span class="op">$</span><span class="va">C</span><span class="op">)</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res_plnpca</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">tic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html" class="external-link">proc.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">res_plnpca</span> <span class="op">&lt;-</span> <span class="fu">PLNPCA_run</span><span class="op">(</span><span class="va">X_count</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Z</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span>,<span class="va">H</span><span class="op">)</span>, q<span class="op">=</span><span class="va">q</span><span class="op">)</span>
<span class="co">#&gt; Loading required package: PLNmodels</span>
<span class="co">#&gt; Warning: package 'PLNmodels' was built under R version 4.1.3</span>
<span class="co">#&gt; This is packages 'PLNmodels' version 1.0.1</span>
<span class="co">#&gt; Use future::plan(multicore/multisession) to speed up PLNPCA/PLNmixture/stability_selection.</span>
<span class="co">#&gt; Warning in common_samples(counts, covariates): There are no matching names in the count matrix and the covariates data.frame.</span>
<span class="co">#&gt; Function will proceed assuming:</span>
<span class="co">#&gt; - samples are in the same order;</span>
<span class="co">#&gt; - samples are rows of the abundance matrix.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  Initialization...</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  Adjusting 1 PLN models for PCA analysis.</span>
<span class="co">#&gt;   Rank approximation = 5 </span>
<span class="co">#&gt;  Post-treatments</span>
<span class="co">#&gt;  DONE!</span>
<span class="va">toc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html" class="external-link">proc.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">time_plnpca</span> <span class="op">&lt;-</span> <span class="va">toc</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">tic</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
  
<span class="va">metricList</span><span class="op">$</span><span class="va">PLNPCA</span><span class="op">$</span><span class="va">F_tr</span> <span class="op">&lt;-</span> <span class="fu">trace_statistic_fun</span><span class="op">(</span><span class="va">res_plnpca</span><span class="op">$</span><span class="va">PCs</span>, <span class="va">F0</span><span class="op">)</span>
<span class="va">metricList</span><span class="op">$</span><span class="va">PLNPCA</span><span class="op">$</span><span class="va">B_tr</span> <span class="op">&lt;-</span> <span class="fu">trace_statistic_fun</span><span class="op">(</span><span class="va">res_plnpca</span><span class="op">$</span><span class="va">loadings</span>, <span class="va">B0</span><span class="op">)</span>
<span class="va">alpha_plnpca</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">res_plnpca</span><span class="op">$</span><span class="va">bbeta</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">k</span>,<span class="op">]</span><span class="op">)</span>
<span class="va">beta_plnpca</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">res_plnpca</span><span class="op">$</span><span class="va">bbeta</span><span class="op">[</span><span class="op">(</span><span class="va">k</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">k</span><span class="op">+</span><span class="va">d</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span>
<span class="va">metricList</span><span class="op">$</span><span class="va">PLNPCA</span><span class="op">$</span><span class="va">alpha_norm1</span> <span class="op">&lt;-</span> <span class="fu">norm1_vec</span><span class="op">(</span><span class="va">alpha_plnpca</span><span class="op">-</span> <span class="va">alpha0</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">alpha0</span><span class="op">)</span><span class="op">)</span>
<span class="va">metricList</span><span class="op">$</span><span class="va">PLNPCA</span><span class="op">$</span><span class="va">beta_norm1</span> <span class="op">&lt;-</span> <span class="fu">norm1_vec</span><span class="op">(</span><span class="va">beta_plnpca</span><span class="op">-</span> <span class="va">bbeta0</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">bbeta0</span><span class="op">)</span><span class="op">)</span>
<span class="va">metricList</span><span class="op">$</span><span class="va">PLNPCA</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;-</span> <span class="va">time_plnpca</span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Then, we implemented MRRR:</li>
</ol>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## MRRR</span>
<span class="co">## Compare with MRRR</span>
<span class="va">mrrr_run</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">Y</span>, <span class="va">X</span>, <span class="va">rank0</span>, <span class="va">q</span><span class="op">=</span><span class="cn">NULL</span>, <span class="va">family</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,
                     <span class="va">familygroup</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span>, <span class="va">epsilon</span> <span class="op">=</span> <span class="fl">1e-4</span>, <span class="va">sv.tol</span> <span class="op">=</span> <span class="fl">1e-2</span>,
                     <span class="va">maxIter</span> <span class="op">=</span> <span class="fl">2000</span>, <span class="va">trace</span><span class="op">=</span><span class="cn">TRUE</span>, <span class="va">truncflag</span><span class="op">=</span><span class="cn">FALSE</span>, <span class="va">trunc</span><span class="op">=</span><span class="fl">500</span><span class="op">)</span><span class="op">{</span>
  <span class="co"># epsilon = 1e-4; sv.tol = 1e-2; maxIter = 30; trace=TRUE</span>
  <span class="co"># Y &lt;- X_count; X &lt;- cbind(Z, H); rank0 = r + ncol(Z)</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va">rrpack</span><span class="op">)</span>
  
  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span>; <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span>
  
  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="va">rank0</span> <span class="op">&lt;-</span> <span class="va">rank0</span><span class="op">+</span><span class="va">q</span>
    <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">X</span>, <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="kw">if</span><span class="op">(</span><span class="va">truncflag</span><span class="op">)</span><span class="op">{</span>
    <span class="co">## Trunction</span>
    <span class="va">Y</span><span class="op">[</span><span class="va">Y</span><span class="op">&gt;</span><span class="va">trunc</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">trunc</span>
    
  <span class="op">}</span>
  
  <span class="va">svdX0d1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/svd.html" class="external-link">svd</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">$</span><span class="va">d</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
  <span class="va">init1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>kappaC0 <span class="op">=</span> <span class="va">svdX0d1</span> <span class="op">*</span> <span class="fl">5</span><span class="op">)</span>
  <span class="va">offset</span> <span class="op">=</span> <span class="cn">NULL</span>
  <span class="va">control</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>epsilon <span class="op">=</span> <span class="va">epsilon</span>, sv.tol <span class="op">=</span> <span class="va">sv.tol</span>, maxit <span class="op">=</span> <span class="va">maxIter</span>,
                 trace <span class="op">=</span> <span class="va">trace</span>, gammaC0 <span class="op">=</span> <span class="fl">1.1</span>, plot.cv <span class="op">=</span> <span class="cn">TRUE</span>,
                 conv.obj <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">fit.mrrr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rrpack/man/mrrr.html" class="external-link">mrrr</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">Y</span>, X<span class="op">=</span><span class="va">X</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span>, family <span class="op">=</span> <span class="va">family</span>, familygroup <span class="op">=</span> <span class="va">familygroup</span>,
                   penstr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>penaltySVD <span class="op">=</span> <span class="st">"rankCon"</span>, lambdaSVD <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,
                   control <span class="op">=</span> <span class="va">control</span>, init <span class="op">=</span> <span class="va">init1</span>, maxrank <span class="op">=</span> <span class="va">rank0</span><span class="op">)</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">fit.mrrr</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">tic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html" class="external-link">proc.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">res_mrrr</span> <span class="op">&lt;-</span> <span class="fu">mrrr_run</span><span class="op">(</span><span class="va">X_count</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Z</span>,<span class="va">H</span><span class="op">)</span>, <span class="va">r</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">Z</span><span class="op">)</span>, q<span class="op">=</span><span class="va">q</span>, truncflag<span class="op">=</span> <span class="cn">TRUE</span>, trunc<span class="op">=</span><span class="fl">1e4</span><span class="op">)</span>
<span class="co">#&gt; Loading required package: rrpack</span>
<span class="co">#&gt; iter =  1  obj/Cnorm_diff =  32871372  </span>
<span class="co">#&gt; iter =  1  obj/Cnorm_diff =  32871372  </span>
<span class="co">#&gt; iter =  1  obj/Cnorm_diff =  32871372  </span>
<span class="co">#&gt; iter =  1  obj/Cnorm_diff =  32871372  </span>
<span class="co">#&gt; iter =  1  obj/Cnorm_diff =  32871372  </span>
<span class="co">#&gt; iter =  1  obj/Cnorm_diff =  32871372  </span>
<span class="co">#&gt; iter =  1  obj/Cnorm_diff =  32871372</span>
<span class="va">toc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html" class="external-link">proc.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">time_mrrr</span> <span class="op">&lt;-</span> <span class="va">toc</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">tic</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></code></pre></div>
<p>Calculate the metrics for MRRR.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hbbeta_mrrr</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">res_mrrr</span><span class="op">$</span><span class="va">coef</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Z</span>,<span class="va">H</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span>
<span class="va">Theta_hb</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">res_mrrr</span><span class="op">$</span><span class="va">coef</span><span class="op">[</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Z</span>,<span class="va">H</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Z</span>,<span class="va">H</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Z</span>,<span class="va">H</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span>
<span class="va">svdTheta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/svd.html" class="external-link">svd</a></span><span class="op">(</span><span class="va">Theta_hb</span>, nu<span class="op">=</span><span class="va">q</span>, nv<span class="op">=</span><span class="va">q</span><span class="op">)</span>
<span class="va">metricList</span><span class="op">$</span><span class="va">MRRR</span><span class="op">$</span><span class="va">F_tr</span> <span class="op">&lt;-</span> <span class="fu">trace_statistic_fun</span><span class="op">(</span><span class="va">svdTheta</span><span class="op">$</span><span class="va">u</span>, <span class="va">F0</span><span class="op">)</span>
<span class="va">metricList</span><span class="op">$</span><span class="va">MRRR</span><span class="op">$</span><span class="va">B_tr</span> <span class="op">&lt;-</span> <span class="fu">trace_statistic_fun</span><span class="op">(</span><span class="va">svdTheta</span><span class="op">$</span><span class="va">v</span>, <span class="va">B0</span><span class="op">)</span>
<span class="va">alpha_mrrr</span> <span class="op">&lt;-</span> <span class="va">hbbeta_mrrr</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="va">k</span><span class="op">]</span>
<span class="va">beta_mrrr</span> <span class="op">&lt;-</span> <span class="va">hbbeta_mrrr</span><span class="op">[</span>,<span class="op">(</span><span class="va">k</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">k</span><span class="op">+</span><span class="va">d</span><span class="op">)</span><span class="op">]</span>
<span class="va">metricList</span><span class="op">$</span><span class="va">MRRR</span><span class="op">$</span><span class="va">alpha_norm1</span> <span class="op">&lt;-</span> <span class="fu">norm1_vec</span><span class="op">(</span><span class="va">alpha_mrrr</span><span class="op">-</span> <span class="va">alpha0</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">alpha0</span><span class="op">)</span><span class="op">)</span>
<span class="va">metricList</span><span class="op">$</span><span class="va">MRRR</span><span class="op">$</span><span class="va">beta_norm1</span> <span class="op">&lt;-</span> <span class="fu">norm1_vec</span><span class="op">(</span><span class="va">beta_mrrr</span><span class="op">-</span> <span class="va">bbeta0</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">bbeta0</span><span class="op">)</span><span class="op">)</span>
<span class="va">metricList</span><span class="op">$</span><span class="va">MRRR</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;-</span> <span class="va">time_mrrr</span></code></pre></div>
<ol start="6" style="list-style-type: decimal">
<li>Finally, we implement FAST that takes into account spatial dependence among units, but unable to account for additional covariates.</li>
</ol>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## FAST</span>
<span class="va">fast_run</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X_count</span>, <span class="va">Adj_sp</span>, <span class="va">q</span>, <span class="va">verbose</span><span class="op">=</span><span class="cn">TRUE</span>, <span class="va">epsELBO</span><span class="op">=</span><span class="fl">1e-8</span><span class="op">)</span><span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/feiyoung/ProFAST" class="external-link">ProFAST</a></span><span class="op">)</span>

  <span class="va">reslist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProFAST/man/FAST_run.html" class="external-link">FAST_run</a></span><span class="op">(</span>XList <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">X_count</span><span class="op">)</span>, 
                      AdjList <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">Adj_sp</span><span class="op">)</span>, q <span class="op">=</span> <span class="va">q</span>, fit.model <span class="op">=</span> <span class="st">'poisson'</span>, 
                      verbose<span class="op">=</span><span class="va">verbose</span>, epsLogLik<span class="op">=</span><span class="va">epsELBO</span><span class="op">)</span>
  <span class="va">reslist</span><span class="op">$</span><span class="va">hV</span> <span class="op">&lt;-</span> <span class="va">reslist</span><span class="op">$</span><span class="va">hV</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">reslist</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">tic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html" class="external-link">proc.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">res_fast</span> <span class="op">&lt;-</span> <span class="fu">fast_run</span><span class="op">(</span><span class="va">X_count</span>, <span class="va">Adj_sp</span>, q<span class="op">=</span><span class="va">q</span>, verbose<span class="op">=</span><span class="cn">TRUE</span>, epsELBO<span class="op">=</span><span class="fl">1e-8</span><span class="op">)</span>
<span class="va">toc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html" class="external-link">proc.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">time_fast</span> <span class="op">&lt;-</span> <span class="va">toc</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">tic</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
<span class="va">metricList</span><span class="op">$</span><span class="va">FAST</span><span class="op">$</span><span class="va">F_tr</span> <span class="op">&lt;-</span> <span class="fu">trace_statistic_fun</span><span class="op">(</span><span class="va">res_fast</span><span class="op">$</span><span class="va">hV</span>, <span class="va">F0</span><span class="op">)</span>
<span class="va">metricList</span><span class="op">$</span><span class="va">FAST</span><span class="op">$</span><span class="va">B_tr</span> <span class="op">&lt;-</span> <span class="fu">trace_statistic_fun</span><span class="op">(</span><span class="va">res_fast</span><span class="op">$</span><span class="va">W</span>, <span class="va">B0</span><span class="op">)</span>
<span class="va">metricList</span><span class="op">$</span><span class="va">FAST</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;-</span> <span class="va">time_fast</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="visualize-the-comparison-of-performance">Visualize the comparison of performance<a class="anchor" aria-label="anchor" href="#visualize-the-comparison-of-performance"></a>
</h2>
<p>Next, we summarized the metrics for COAP and other compared methods in a dataframe object.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">list2vec</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">xlist</span><span class="op">)</span><span class="op">{</span>
  <span class="va">nn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">xlist</span><span class="op">)</span>
  <span class="va">me</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">nn</span><span class="op">)</span>
  <span class="va">idx_noNA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">xlist</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">r</span> <span class="kw">in</span> <span class="va">idx_noNA</span><span class="op">)</span> <span class="va">me</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">xlist</span><span class="op">[[</span><span class="va">r</span><span class="op">]</span><span class="op">]</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">me</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">dat_metric</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Tr_F <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">metricList</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">F_tr</span><span class="op">)</span>, 
                         Tr_B <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">metricList</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">B_tr</span><span class="op">)</span>,
                         err_alpha <span class="op">=</span><span class="fu">list2vec</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">metricList</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">alpha_norm1</span><span class="op">)</span><span class="op">)</span>,
                         err_beta <span class="op">=</span> <span class="fu">list2vec</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">metricList</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">beta_norm1</span><span class="op">)</span><span class="op">)</span>,
                         time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">metricList</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">time</span><span class="op">)</span>,
                         Method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">metricList</span><span class="op">)</span><span class="op">)</span>
<span class="va">dat_metric</span><span class="op">$</span><span class="va">Method</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">dat_metric</span><span class="op">$</span><span class="va">Method</span>, levels<span class="op">=</span><span class="va">dat_metric</span><span class="op">$</span><span class="va">Method</span><span class="op">)</span></code></pre></div>
<p>Plot the results for COAP and other methods, which suggests that COAP achieves better estimation accuracy for the quantiites of interest.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/cowplot/" class="external-link">cowplot</a></span><span class="op">)</span>
<span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">dat_metric</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Tr_B</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span> <span class="va">Method</span>, y<span class="op">=</span><span class="va">Tr_B</span>, fill<span class="op">=</span><span class="va">Method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat<span class="op">=</span><span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html" class="external-link">scale_x_discrete</a></span><span class="op">(</span>breaks<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">16</span><span class="op">)</span>
<span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">dat_metric</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Tr_F</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span> <span class="va">Method</span>, y<span class="op">=</span><span class="va">Tr_F</span>, fill<span class="op">=</span><span class="va">Method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat<span class="op">=</span><span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html" class="external-link">scale_x_discrete</a></span><span class="op">(</span>breaks<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">16</span><span class="op">)</span>
<span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">dat_metric</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">err_alpha</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span> <span class="va">Method</span>, y<span class="op">=</span><span class="va">err_alpha</span>, fill<span class="op">=</span><span class="va">Method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat<span class="op">=</span><span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html" class="external-link">scale_x_discrete</a></span><span class="op">(</span>breaks<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">16</span><span class="op">)</span>
<span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">dat_metric</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">err_beta</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span> <span class="va">Method</span>, y<span class="op">=</span><span class="va">err_beta</span>, fill<span class="op">=</span><span class="va">Method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat<span class="op">=</span><span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html" class="external-link">scale_x_discrete</a></span><span class="op">(</span>breaks<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">16</span><span class="op">)</span>
<span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">p1</span>,<span class="va">p2</span>,<span class="va">p3</span>, <span class="va">p4</span>, nrow<span class="op">=</span><span class="fl">2</span>, ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span></code></pre></div>
<p><img src="simu_files/figure-html/unnamed-chunk-14-1.png" width="864"></p>
</div>
<div class="section level2">
<h2 id="select-the-parameters">Select the parameters<a class="anchor" aria-label="anchor" href="#select-the-parameters"></a>
</h2>
<p>We applied the singular value ratio based method to select the number of factors and the rank of coefficient matrix. The results showed that the SVR method has the potential to identify the true values.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chooseParams.html">chooseParams</a></span><span class="op">(</span><span class="va">X_count</span>, <span class="va">Adj_sp</span>, <span class="va">H</span>, <span class="va">Z</span>, verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; Calculate initial values...</span>
<span class="co">#&gt; Model fitting...</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>q_true<span class="op">=</span><span class="va">q</span>, q_est<span class="op">=</span><span class="va">res1</span><span class="op">[</span><span class="st">'hq'</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;   q_true q_est.hq </span>
<span class="co">#&gt;        5        5</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>r_true<span class="op">=</span><span class="va">r</span>, r_est<span class="op">=</span><span class="va">res1</span><span class="op">[</span><span class="st">'hr'</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;   r_true r_est.hr </span>
<span class="co">#&gt;        3        4</span></code></pre></div>
<details><p><summary><strong>Session Info</strong></summary></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; R version 4.1.2 (2021-11-01)</span>
<span class="co">#&gt; Platform: x86_64-w64-mingw32/x64 (64-bit)</span>
<span class="co">#&gt; Running under: Windows 10 x64 (build 22631)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Matrix products: default</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; locale:</span>
<span class="co">#&gt; [1] LC_COLLATE=Chinese (Simplified)_China.936 </span>
<span class="co">#&gt; [2] LC_CTYPE=Chinese (Simplified)_China.936   </span>
<span class="co">#&gt; [3] LC_MONETARY=Chinese (Simplified)_China.936</span>
<span class="co">#&gt; [4] LC_NUMERIC=C                              </span>
<span class="co">#&gt; [5] LC_TIME=Chinese (Simplified)_China.936    </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; attached base packages:</span>
<span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; other attached packages:</span>
<span class="co">#&gt;  [1] cowplot_1.1.1        rrpack_0.1-11        PLNmodels_1.0.1     </span>
<span class="co">#&gt;  [4] COAP_1.2             ggplot2_3.4.1        irlba_2.3.5         </span>
<span class="co">#&gt;  [7] Matrix_1.4-0         LaplacesDemon_16.1.6 MASS_7.3-55         </span>
<span class="co">#&gt; [10] SpaCOAP_1.2         </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; loaded via a namespace (and not attached):</span>
<span class="co">#&gt;  [1] tidyr_1.2.0           sass_0.4.1            splines_4.1.2        </span>
<span class="co">#&gt;  [4] bit64_4.0.5           jsonlite_1.8.0        foreach_1.5.2        </span>
<span class="co">#&gt;  [7] bslib_0.3.1           assertthat_0.2.1      highr_0.9            </span>
<span class="co">#&gt; [10] yaml_2.3.6            corrplot_0.92         globals_0.15.0       </span>
<span class="co">#&gt; [13] GFM_1.2.1             pillar_1.9.0          lattice_0.20-45      </span>
<span class="co">#&gt; [16] glue_1.6.2            torch_0.9.1           doSNOW_1.0.20        </span>
<span class="co">#&gt; [19] digest_0.6.29         colorspace_2.1-0      htmltools_0.5.2      </span>
<span class="co">#&gt; [22] pkgconfig_2.0.3       listenv_0.8.0         purrr_0.3.4          </span>
<span class="co">#&gt; [25] scales_1.2.1          snow_0.4-4            processx_3.5.2       </span>
<span class="co">#&gt; [28] tibble_3.2.1          generics_0.1.2        farver_2.1.1         </span>
<span class="co">#&gt; [31] cachem_1.0.6          withr_2.5.0           cli_3.2.0            </span>
<span class="co">#&gt; [34] survival_3.2-13       magrittr_2.0.3        crayon_1.5.1         </span>
<span class="co">#&gt; [37] memoise_2.0.1         evaluate_0.15         ps_1.6.0             </span>
<span class="co">#&gt; [40] fs_1.5.2              fansi_1.0.4           future_1.26.1        </span>
<span class="co">#&gt; [43] parallelly_1.32.0     textshaping_0.3.6     tools_4.1.2          </span>
<span class="co">#&gt; [46] lifecycle_1.0.3       lassoshooting_0.1.5-1 stringr_1.4.0        </span>
<span class="co">#&gt; [49] glassoFast_1.0        glmnet_4.1-3          munsell_0.5.0        </span>
<span class="co">#&gt; [52] callr_3.7.0           compiler_4.1.2        pkgdown_2.0.6        </span>
<span class="co">#&gt; [55] jquerylib_0.1.4       systemfonts_1.0.4     rlang_1.1.0          </span>
<span class="co">#&gt; [58] grid_4.1.2            nloptr_2.0.0          iterators_1.0.14     </span>
<span class="co">#&gt; [61] rstudioapi_0.13       igraph_1.3.5          labeling_0.4.2       </span>
<span class="co">#&gt; [64] rmarkdown_2.11        gtable_0.3.3          codetools_0.2-18     </span>
<span class="co">#&gt; [67] DBI_1.1.2             R6_2.5.1              gridExtra_2.3        </span>
<span class="co">#&gt; [70] knitr_1.37            dplyr_1.0.9           future.apply_1.9.0   </span>
<span class="co">#&gt; [73] fastmap_1.1.0         bit_4.0.4             utf8_1.2.3           </span>
<span class="co">#&gt; [76] rprojroot_2.0.3       ragg_1.2.2            coro_1.0.3           </span>
<span class="co">#&gt; [79] shape_1.4.6           desc_1.4.0            stringi_1.7.6        </span>
<span class="co">#&gt; [82] parallel_4.1.2        Rcpp_1.0.10           vctrs_0.6.1          </span>
<span class="co">#&gt; [85] tidyselect_1.1.2      xfun_0.29</span></code></pre></div>
</details>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Wei Liu, Qingzhi Zhong.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
